---
title: "Bioinformatics pipeline summary"
subtitle: "Where we see the pipeline processes"
date: last-modified
author:
  - name: Adrien Taudi√®re
    url: https://adrientaudiere.github.io/bioinfo.starter/analysis/01_bioinformatics.qmd
    affiliation: IdEst
    affiliation-url: https://orcid.org/my-orcid?orcid=0000-0003-1088-1182
citation: true
# bibliography: bibliography.bib
# link-citations: true
---

# Summary of the bioinformatic pipeline

```{r, message=FALSE, warning=FALSE}
library(knitr)
library(targets)
library(MiscMetabar)
here::i_am("analysis/01_bioinformatics.qmd")
```

```{r}
d_pq <- clean_pq(tar_read("d_vs", store=here::here("_targets/")))
```

```{r}
summary_plot_pq(d_pq)
```

```{r Visualise target plan, out.width='80%'}
tar_glimpse(script=here::here("_targets.R"), targets_only = TRUE, callr_arguments = list(show = FALSE))
```

```{r}
tar_meta(store=here::here("_targets/"), targets_only = TRUE) |> 
  dplyr::mutate(time = paste0(seconds %/% 3600,":",seconds %/% 60,":",floor(seconds %% 60)))|>
  dplyr::select(name, seconds, bytes, format, time) |>
  dplyr::mutate(Gb=round(bytes/10^9,2)) |>
  dplyr::arrange(desc(seconds), desc(bytes))  |> 
  kable()
```


## Load phyloseq object from targets store

```{r}
d_pq <- tar_read("d_vs", store=here::here("_targets/"))
```

<hr/>

The {targets} package is at the core of this project. Please read the intro of the [user manual](https://books.ropensci.org/targets/) if you don't know {targets}.

::: {.cell .page-columns .page-full .column-screen .grey-section}
The {targets} package store ... *targets* in a folder and can load (`tar_load()`) and read (`tar_read`) object from this folder.
:::

## Sample data

```{r}
DT::datatable(d_pq@sam_data)
```

## Sequences, samples and clusters across the pipeline


::: {.panel-tabset .nav-pills}
## All samples together

```{r}
kable(tar_read(track_sequences_samples_clusters, store=here::here("_targets/")))
```

## Per samples

```{r}
#| message: false
#| results: asis
tab_samp <- tar_read(track_by_samples, store=here::here("_targets/"))

for (li in names(tab_samp)) {
  print(knitr::kable(tab_samp[[li]], caption = li, format="html"))
  cat('\n<!-- -->\n\n')
}
```

:::



### Compare taxonomy using either Marjaam or Eukaryome database

```{r}
krona(d_asv, file = here::here("data", "data_final", "Marjaam.html"), ranks= 2:7, name="Marjaam")
krona(d_asv, file = here::here("data", "data_final", "Eukaryome.html"), ranks= 10:15, name="Eukaryome")

merge_krona(c(here::here("data", "data_final", "Marjaam.html"), here::here("data", "data_final", "Eukaryome.html")), here::here("data", "data_final", "compare_tax_database.html"))
```

```{r}
table(d_pq@tax_table[,"Family"])
table(d_pq@tax_table[,"Family__eukaryome_Glomero"])

table(d_pq@tax_table[,"Genus"])
table(d_pq@tax_table[,"Genus__eukaryome_Glomero"])
```


```{r}
psm <- psmelt(d_pq)

d_pq@sam_data$expe = "Solace_AM"

ggplot(psm, aes(y=Abundance,  x = Type, fill = Genus)) +
  geom_bar(stat="identity")


plot_tax_pq(
  d_pq,
  "Type", 
  type = "nb_taxa",
  taxa_fill="Class",
  color_border = rgb(0, 0, 0, 0)
)  

plot_tax_pq(
  d_pq,
  "Type", 
  type = "nb_taxa",
  taxa_fill="Class__eukaryome_Glomero",
  color_border = rgb(0, 0, 0, 0)
)  

```

```{r}

```


{{< include _session_info.qmd >}}
